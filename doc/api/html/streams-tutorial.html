<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>HPCloud-PHP: Tutorial: Using Stream Wrappers</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">HPCloud-PHP
   &#160;<span id="projectnumber">-UNSTABLE%</span>
   </div>
   <div id="projectbrief">PHP bindings for HPCloud and OpenStack services.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('streams-tutorial.html','');
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Tutorial: Using Stream Wrappers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an introduction to the HPCloud-PHP library. While the library is large and feature-rich, this tutorial focuses on the Stream Wrapper feature. (There is also a 00-tutorial "tutorial about the object-oriented
library".)</p>
<h2>TL;DR</h2>
<p>With a few lines of setup code, you can fetch objects from HP Cloud's object storage using built-in PHP functions like this:</p>
<div class="fragment"><pre class="fragment">&lt;?php
<span class="comment">// Create a new file and write it to the object store.</span>
<a class="code" href="streams-tutorial-example_8php.html#a26b8173b965263e5d11af5a1d18332b4">$newfile</a> = fopen(<span class="stringliteral">&#39;swift://Example/my_file.txt&#39;</span>, <span class="charliteral">&#39;w&#39;</span>);
fwrite($newfile, <span class="stringliteral">&quot;Good Morning!&quot;</span>);
fclose($newfile);

<span class="comment">// Check for an object:</span>
<span class="keywordflow">if</span> (file_exists(<span class="stringliteral">&#39;swift://Example/my_file.txt&#39;</span>)) {
  print <span class="stringliteral">&quot;Found my_file.txt.&quot;</span> . <a class="code" href="streams-tutorial-example_8php.html#ad50e7caf4a5d9866dc147787a5928678">PHP_EOL</a>;
}

<span class="comment">// Get an entire object at once:</span>
<a class="code" href="streams-tutorial-example_8php.html#ad49a2659ea99542f3b17418b5e20f1a6">$file</a> = file_get_contents(<span class="stringliteral">&#39;swift://Example/my_file.txt&#39;</span>);
print <span class="stringliteral">&#39;File: &#39;</span> . <a class="code" href="streams-tutorial-example_8php.html#ad49a2659ea99542f3b17418b5e20f1a6">$file</a> . <a class="code" href="streams-tutorial-example_8php.html#ad50e7caf4a5d9866dc147787a5928678">PHP_EOL</a>;
?&gt;
</pre></div><p>In fact, the vast majority of file and stream functions work with <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a>'s <code>swift://</code> URLs.</p>
<p>The rest of this tutorial explains how they work.</p>
<h2>The Setup</h2>
<p>The example above does not show the code necessary for initializing the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> stream wrapper. In this section, we will look at the necessary setup code.</p>
<h3>Loading Classes</h3>
<p>The <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> PHP library is structured following SPR-0 recommendations. Practically speaking, what this means is that applications that use an SPR-0 autoloader may be able to automatically load the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> library.</p>
<p>However, we'll assume that that is not the case. We'll assume that the library needs to be initialized manually.</p>
<p>What we will do is first load the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> <a class="el" href="_bootstrap_8php.html" title="HP Cloud configuration.">Bootstrap.php</a> file, and then use the autoloader in that file to load the rest of the library:</p>
<div class="fragment"><pre class="fragment">&lt;?php
require_once <span class="stringliteral">&#39;/HPCloud/Bootstrap.php&#39;</span>;

use \HPCloud\Bootstrap;
Bootstrap::useAutoloader();
Bootstrap::useStreamWrappers();
?&gt;
</pre></div><p>The first thing the example above does is require the <a class="el" href="_bootstrap_8php.html" title="HP Cloud configuration.">Bootstrap.php</a> file, which contains code necessary for initializing the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> library.</p>
<p>Next, we call two static methods on the <a class="el" href="class_h_p_cloud_1_1_bootstrap.html" title="Bootstrapping services.">HPCloud::Bootstrap</a> object:</p>
<ul>
<li>Bootstrap::useAutoLoader(): This tells <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> to load any other classes on demand. Since we use this, we don't need any more <code>require</code> or <code>include</code> statements.</li>
<li>Bootstrap::useStreamWrappers(): This tells <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> to register its stream wrapper classes.</li>
</ul>
<p>In a nutshell, PHP allows libraries to map a particular URL pattern to a stream wrapper. <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> registers the <code>swift://</code> URL prefix. So any request to a URL beginning with <code>swift://</code> will be proxied through the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> library.</p>
<h2>Setting Up Authentication</h2>
<p>When working with remote <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> Object Storage, you must authenticate to the remote system. Authentication requires the following four pieces of information:</p>
<ul>
<li>account: Your account ID</li>
<li>key: Your account's secret key</li>
<li>tenantid: The tenant ID for the services you wish to use</li>
<li>endpoint: The endpoint URL for <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a>'s Identity Services. It usually looks something like this: <code><a href="https://region-a.geo-1.identity.hpcloudsvc.com:35357">https://region-a.geo-1.identity.hpcloudsvc.com:35357</a></code></li>
</ul>
<p>All four of these pieces of information can be found in the <b>API Keys</b> section of your <a href="https://manage.hpcloud.com">management console</a> account.</p>
<p>(Note: You can use your username and password instead of account and key, but you still must supply the tenant ID. Instead of supplying <code>account</code> and <code>key</code>, use <code>username</code> and <code>password</code>.)</p>
<p>We are going to look at two ways to set authentication information. The first is global. That means we supply it once, and all stream and file functions automatically use that information. The second is to pass authentication information into the stream context.</p>
<h3>Global Configuration</h3>
<p>Supplying global account information has two distinct advantages:</p>
<ol type="1">
<li>It reduces the complexity of your code</li>
<li>It allows context-less functions like <code>file_exists</code> and <code>stat</code> to work.</li>
</ol>
<p>But it has a disadvantage: <em>Only one account can be used at a time.</em> Since that account's information is shared across all stream wrappers, they all share the same account, tenant Id, and service catalog.</p>
<p>If you are working on an application that needs to connect to more than one account in the same request, you may find this setup imperfect for your needs.</p>
<p>That said, here's how we set up a global configuration:</p>
<div class="fragment"><pre class="fragment"><a class="code" href="streams-tutorial-example_8php.html#ac7c3353107070daa85f641882931b358">$settings</a> = array(
  <span class="stringliteral">&#39;account&#39;</span> =&gt; YOUR_ACCOUNT_NUMBER,
  <span class="stringliteral">&#39;key&#39;</span> =&gt; YOUR_SECRET_KEY,
  <span class="stringliteral">&#39;tenantid&#39;</span> =&gt; YOUR_TENANT_ID,
  <span class="stringliteral">&#39;endpoint&#39;</span> =&gt; IDENTITY_SERVICES_URL,

  <span class="comment">// Instead of account/key you can use this:</span>
  <span class="comment">// &#39;username&#39; =&gt; YOUR_USERNAME,</span>
  <span class="comment">// &#39;password&#39; =&gt; YOUR_PASSWORD,</span>
);
Bootstrap::setConfiguration(<a class="code" href="streams-tutorial-example_8php.html#ac7c3353107070daa85f641882931b358">$settings</a>);
</pre></div><p>Basically, what we do above is declare an associative array of configuration parameters and then tell <a class="el" href="class_h_p_cloud_1_1_bootstrap.html" title="Bootstrapping services.">HPCloud::Bootstrap</a> to set these as the default configuration.</p>
<p>Once the above is done, all of those PHP stream and file functions will just work. All you need to do is pass them <code>swift://</code> URLs, and they will do the rest.</p>
<h2>The Format of Swift URLs</h2>
<p>Early in the tutorial we saw some swift URLs like this: <code>swift://Example/my_file.txt</code> . What is this URL referencing?</p>
<p>The URL above has three important parts, in the form <code>swift://CONTAINER/OBJECT_NAME</code>.</p>
<ul>
<li><em>swift://</em>: This is the schema. This part of the URL tells PHP to pass the request to the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> stream wrapper. (Swift, by the way, is the <a href="http://openstack.org/projects/storage/">OpenStack name for object storage</a>.</li>
<li><em>Example</em>: This is the <em>container name</em>. In Object Storage parlance, a container is a place to store documents. One account can have lots of containers, and each container can have lots of objects.</li>
<li><em>my_file.txt</em>: This is the object name. An object is basically the same as a file.</li>
</ul>
<p>Swift does not support directories, but it does allow slashes in object names. So `swift://Example/this/is/my/file.png' checks the container <em>Example</em> for the object named <code>this/is/my/file.png</code>.</p>
<p>(For power users, there are some fancy operations you can do to treat Swift filename parts as if they were directories. Check out <a class="el" href="class_h_p_cloud_1_1_storage_1_1_object_storage_1_1_container.html" title="A container in an ObjectStorage.">HPCloud::Storage::ObjectStorage::Container</a>.)</p>
<h2>Using Stream Contexts for Authentication</h2>
<p>Sometimes it is better to pass authentication information directly to the stream or file function, instead of relying upon a global configuration. PHP provides for this with <b>stream contexts</b>.</p>
<p>Stream contexts have one major downside: Not all PHP functions accept stream contexts. Here are some notable examples:</p>
<ul>
<li>file_exists()</li>
<li>is_readable()</li>
<li>stat()</li>
</ul>
<p>(Basically, anything that calls the underlying <code>stat(3)</code>.)</p>
<p>The advantage, though, is that each call can have its own authentication data. This is good for supporting multiple accounts, and can also be used to optimize long-term performance (e.g. by saving authentication tokens in a database and re-using them).</p>
<p>Here's how a stream context is used:</p>
<div class="fragment"><pre class="fragment">&lt;?php
require_once __DIR__ . <span class="stringliteral">&#39;/../src/HPCloud/Bootstrap.php&#39;</span>;

use \HPCloud\Bootstrap;
Bootstrap::useAutoloader();
Bootstrap::useStreamWrappers();

<a class="code" href="streams-tutorial-example_8php.html#ab8dcbed10863cd3734ef850387337cf4">$cxt</a> = stream_context_create(array(
  <span class="stringliteral">&#39;swift&#39;</span> =&gt; array(
    <span class="stringliteral">&#39;account&#39;</span> =&gt; YOUR_ACCOUNT_NUMBER,
    <span class="stringliteral">&#39;key&#39;</span> =&gt; YOUR_SECRET_KEY,
    <span class="stringliteral">&#39;tenantid&#39;</span> =&gt; YOUR_TENANT_ID,
    <span class="stringliteral">&#39;endpoint&#39;</span> =&gt; IDENTITY_SERVICES_URL,

    <span class="comment">// Instead of account/key you can use this:</span>
    <span class="comment">// &#39;username&#39; =&gt; YOUR_USERNAME,</span>
    <span class="comment">// &#39;password&#39; =&gt; YOUR_PASSWORD,</span>
  ),
));

print file_get_contents(<span class="stringliteral">&#39;swift://Example/my_file.txt&#39;</span>, FALSE, <a class="code" href="streams-tutorial-example_8php.html#ab8dcbed10863cd3734ef850387337cf4">$cxt</a>);
?&gt;
</pre></div><p>The main difference is the creation of <code>$cxt</code> using PHP's <code>stream_context_create()</code>. To fully understand this, you may want to take a look at the <a href="http://us3.php.net/manual/en/book.stream.php">PHP documentation</a> for streams.</p>
<h2>Summary</h2>
<p>This tutorial is focused on using stream wrappers to interact with your <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> Object Storage service. We focused on configuring the environment for transparently using PHP functions like <code>fopen()</code> and <code>file_get_contents()</code> to work with objects in <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a>'s object storage.</p>
<p>This is just one way of interoperating with the <a class="el" href="namespace_h_p_cloud.html" title="The HPCloud PHP library.">HPCloud</a> library. For more detail-oriented work, you may find the Object Oriented facilities better suited. You can read <a class="el" href="oo-tutorial.html">the OO tutorial</a> to learn more about that.</p>
<p>Addidtionally, you may wish to learn more about the internals of the stream wrapper, the main class, <a class="el" href="class_h_p_cloud_1_1_storage_1_1_object_storage_1_1_stream_wrapper.html" title="Provides stream wrapping for Swift.">HPCloud::Storage::ObjectStorage::StreamWrapper</a>, is well-documented. </p>
</div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>

    <li class="footer">Generated on Mon Apr 9 2012 16:22:31 for HPCloud-PHP by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.0 </li>
   </ul>
 </div>


</body>
</html>
